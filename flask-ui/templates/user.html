{% extends 'base.html' %}
{% block title %}{{ username }}’s Public Trackers{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
  <h2 class="text-3xl font-bold mb-6 text-gray-800">
    {{ username }}’s Trackers
  </h2>
  <button id="friends-btn"
          class="text-blue-600 hover:underline text-sm mb-6">
    <span id="friend-count">…</span> friends
  </button>

  <!-- View‐Range Controls -->
  <div class="flex items-center space-x-4 mb-6">
    <div class="space-x-2">
      <label class="inline-flex items-center">
        <input type="radio" name="viewRange" value="week" checked
               class="form-radio text-blue-500"/>
        <span class="ml-2">This Week</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="viewRange" value="month"
               class="form-radio text-blue-500"/>
        <span class="ml-2">This Month</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="viewRange" value="year"
               class="form-radio text-blue-500"/>
        <span class="ml-2">Last 365</span>
      </label>
    </div>
  </div>

  {% if trackers %}
    <div id="calendar-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for t in trackers %}
        <div
          class="tracker-card bg-white rounded-lg shadow p-4"
          data-tracker-id="{{ t.id }}"
          data-aggregate='{{ t.aggregate | tojson }}'
          data-rule='{{ t.rule      | tojson }}'
          data-color="{{ t.color }}"
          data-widget-type="{{ t.widget_type }}"
        >
          <h3 class="text-xl font-semibold mb-2">
            {{ t.name }}
          </h3>
          <p class="text-sm mb-4 text-gray-600">
            {% for period, count in t.rule.items() %}
              {{ count }}× {{ period.replace('_',' ') }}
            {% endfor %}
          </p>
          <div class="calendar grid grid-cols-7 gap-2"></div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-600">No trackers to show.</p>
  {% endif %}
</div>

<script>
  // signal to calendar.js that we're on a public profile
  window.PUBLIC_USERNAME = "{{ username|e }}";
</script>
<script src="/static/js/calendar.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    /** Elements */
    const badge   = document.getElementById('friend-badge');
    const overlay = document.getElementById('friends-overlay');
    const panel   = document.getElementById('friends-panel');
    const listUL  = document.getElementById('friends-list');
    const closeBt = document.getElementById('friends-close');
    const countEl = document.getElementById('friend-count');

    /* `me` as real JS object */
    const me = JSON.parse('{{ user | tojson | safe }}');

    /** Fetch friends from backend */
    async function fetchFriends(){
      const friends = await window.apiFetch(
        `/api/users/${encodeURIComponent(me.username)}/friends`
      );
      renderList(friends);
      return friends;
    }

    function renderBadge(count) {
      countEl.textContent = count;
      document.getElementById('friend-label').textContent =`friend${count === 1 ? '' : 's'}`;
    }

    // Initial load
    (async () => {
      try {
        const friends = await fetchFriends();
        renderBadge(friends.length);
      } catch (e) {
        console.error('Friend fetch failed:', e);
      }
    })();

    /** Replace badge + list */
    function renderList(friends){
      countEl.textContent = friends.length;
      listUL.innerHTML = friends.length
        ? friends.map(u => `
            <li class="flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100">
              <span class="inline-flex justify-center items-center h-8 w-8 rounded-full
                          bg-blue-500 text-white uppercase text-sm">
                ${u.username[0]}
              </span>
              <span class="text-gray-800">${u.username}</span>
            </li>`).join('')
        : '<li class="text-gray-500 px-3 py-2">No friends yet</li>';
    }

    /** Open overlay */
    async function open(){
      try{
        await fetchFriends();
        overlay.classList.remove('hidden');
        // Tailwind-only “pop-in” without @keyframes
        requestAnimationFrame(()=>panel.classList.remove('scale-90','opacity-0'));
      }catch(err){
        console.error('[friends-overlay] fetch failed',err);
        alert('Could not fetch friends');
      }
    }

    /** Close overlay */
    function close(){
      panel.classList.add('scale-90','opacity-0');
      setTimeout(()=>overlay.classList.add('hidden'),200);
    }

    badge.addEventListener('click', open);
    overlay.addEventListener('click', e=>{
      if(e.target===overlay||e.target===closeBt) close();
    });

    /* Whenever another part of the UI adds a friend, dispatch: */
    document.addEventListener('friend-added', fetchFriends);
  });
</script>
{% endblock %}